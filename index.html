<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Qlik Cloud Mashup</title>
  <!-- Load require.js from CDN -->
  <script src="https://cdn.jsdelivr.net/gh/qlik-oss/requirejs@2.3.6/require.min.js"></script>
</head>
<body>
  <h2>Qlik Cloud Mash</h2>
  <div id="qs-object" style="height: 600px;"></div>
  <div id="error-message" style="color: red; margin-top: 16px;"></div>

  <script>
    const tenant = "q-likhack251-459898.us.qlikcloud.com";
    const webIntegrationId = "458a485c626995e8a80a8bac9eb21ac1";
    const appId = "03011cc2-27b2-4060-9570-1275ee044884";
    const sheetId = "rXtfDa";

    require.config({
      baseUrl: `https://${tenant}/resources`
    });

    function showError(msg) {
      document.getElementById("error-message").textContent = msg;
    }

    async function initMashup() {
      try {
        const res = await fetch(`https://${tenant}/api/v1/users/me`, {
          credentials: "include",
          headers: {
            "qlik-web-integration-id": webIntegrationId,
          },
        });

        if (res.status === 401) {
          const loginUrl = `https://${tenant}/login?qlik-web-integration-id=${webIntegrationId}&returnto=${encodeURIComponent(window.location.href)}`;
          window.location.href = loginUrl;
          return;
        }

        const user = await res.json();
        console.log("Authenticated as:", user);

        require(["js/qlik"], function(qlik) {
          qlik.setOnError(function(error) {
            console.error("Qlik error:", error);
            showError("Qlik error: " + (error.message || error));
          });

          const app = qlik.openApp(appId, {
            host: tenant,
            prefix: "/",
            port: 443,
            isSecure: true,
            webIntegrationId: webIntegrationId
          });

          app.getObject("qs-object", sheetId).catch(function(err) {
            console.error("Failed to load sheet:", err);
            showError("Failed to load Qlik sheet: " + (err.message || err));
          });

          window.addEventListener("message", (event) => {
            if (event.data?.type === "account_ids_selected") {
              const ids = event.data.accountIds || [];
              console.log("Received Account_IDs via postMessage:", ids);
              if (ids.length > 0) {
                app.field("Account_ID").selectValues(
                  ids.map(id => ({ qText: id })),
                  false,
                  false
                );
              }
            }
          });
        });
      } catch (err) {
        console.error("Mashup init error:", err);
        showError("Mashup initialization error: " + err);
      }
    }

    initMashup();
  </script>
</body>
</html>
