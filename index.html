<!DOCTYPE html>
<html>
<head>
  <title>Qlik Mashup with Message Listener</title>
  <script src="https://q-likhack251-459898.us.qlikcloud.com/resources/assets/external/require.js"></script>
</head>
<body style="margin: 0; padding: 32px; font-family: sans-serif;">
  <h2>Qlik Mashup</h2>
  <div id="qs-object" style="height: 600px;"></div>

  <script>
    require.config({
      baseUrl: "https://q-likhack251-459898.us.qlikcloud.com/resources"
    });

    require(["js/qlik"], function (qlik) {
      // Error handling for Qlik
      qlik.on("error", function (error) {
        console.error("Qlik error:", error);
        if (error.code === 16 || (error.message && error.message.includes("authentication"))) {
          // Not authenticated, redirect to login
          const webIntegrationId = "458a485c626995e8a80a8bac9eb21ac1";
          const url = "https://q-likhack251-459898.us.qlikcloud.com/login?qlik-web-integration-id=" + webIntegrationId + "&returnto=" + encodeURIComponent(window.location.href);
          window.location.href = url;
        }
      });

      // Open the app
      const app = qlik.openApp("03011cc2-27b2-4060-9570-1275ee044884", {
        host: "q-likhack251-459898.us.qlikcloud.com",
        prefix: "/",
        port: 443,
        isSecure: true,
        webIntegrationId: "458a485c626995e8a80a8bac9eb21ac1"
      });

      if (!app) {
        console.error("Failed to open Qlik app. Check app ID and permissions.");
        return;
      }

      // Try to get the object and log errors if any
      app.getObject("qs-object", "rXtfDa").catch(function(err) {
        console.error("Failed to get Qlik object:", err);
      });

      // Listen for postMessage
      window.addEventListener("message", (event) => {
        if (event.data?.type === "account_ids_selected") {
          const ids = event.data.accountIds || [];
          console.log("Received Account_IDs via postMessage:", ids);
          if (ids.length > 0) {
            const field = app.field("Account_ID");
            field.selectValues(ids.map(id => ({ qText: id })), false, false);
          }
        }
      });
    });
  </script>
</body>
</html>
