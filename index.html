<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Qlik Cloud Mashup â€“ Auth Safe</title>
  <style>
    body {
      margin: 0;
      padding: 32px;
      font-family: sans-serif;
      background: #f9f9f9;
    }
    #selections {
      height: 40px;
      margin-bottom: 16px;
    }
    #qs-object {
      height: 600px;
    }
    #error-message {
      color: red;
      margin-top: 16px;
    }
  </style>
</head>
<body>
  <h2>Qlik Sheet Embed (Auth Safe)</h2>
  <div id="selections"></div>
  <div id="qs-object"></div>
  <div id="error-message"></div>

  <script>
    const tenant = "q-likhack251-459898.us.qlikcloud.com";
    const webIntegrationId = "458a485c626995e8a80a8bac9eb21ac1";
    const appId = "03011cc2-27b2-4060-9570-1275ee044884";
    const sheetId = "rXtfDa";

    function showError(msg) {
      document.getElementById("error-message").textContent = msg;
    }

    async function checkAuth() {
      try {
        const res = await fetch(`https://${tenant}/api/v1/users/me`, {
          credentials: "include",
          headers: {
            "qlik-web-integration-id": webIntegrationId
          }
        });

        if (res.status === 401) {
          // Redirect to login if not authenticated
          window.location.href = `https://${tenant}/login?qlik-web-integration-id=${webIntegrationId}&returnto=${encodeURIComponent(window.location.href)}`;
          return false;
        }

        const user = await res.json();
        console.log("Authenticated as:", user);
        return true;
      } catch (err) {
        showError("Authentication check failed: " + err);
        return false;
      }
    }

    function loadRequireJs() {
      return new Promise((resolve, reject) => {
        const script = document.createElement("script");
        script.src = "https://cdn.jsdelivr.net/gh/qlik-oss/requirejs@2.3.6/require.min.js";
        script.onload = () => resolve();
        script.onerror = () => reject(new Error("Failed to load require.js"));
        document.head.appendChild(script);
      });
    }

    async function initQlik() {
      try {
        await loadRequireJs();

        require.config({
          baseUrl: `https://${tenant}/resources`
        });

        require(["js/qlik"], (qlik) => {
          qlik.setOnError(error => {
            console.error("Qlik error:", error);
            showError("Qlik error: " + (error.message || error));
          });

          const app = qlik.openApp(appId, {
            host: tenant,
            prefix: "/",
            port: 443,
            isSecure: true,
            webIntegrationId: webIntegrationId
          });

          // Load selections toolbar
          app.getObject("selections", "CurrentSelections").catch(err => {
            console.warn("CurrentSelections not available:", err);
          });

          // Load the full sheet
          app.getObject("qs-object", sheetId)
            .then(() => console.log("Sheet loaded successfully"))
            .catch(err => {
              console.error("Failed to load sheet:", err);
              showError("Failed to load Qlik sheet: " + (err.message || err));
            });

          // Listen for postMessage to select Account_IDs
          window.addEventListener("message", (event) => {
            if (event.data?.type === "account_ids_selected") {
              const ids = event.data.accountIds || [];
              console.log("Received Account_IDs via postMessage:", ids);
              if (ids.length > 0) {
                app.field("Account_ID").selectValues(
                  ids.map(id => ({ qText: id })),
                  false,
                  false
                );
              }
            }
          });
        });
      } catch (err) {
        showError("Error loading Qlik resources: " + err);
      }
    }

    (async () => {
      const isAuthenticated = await checkAuth();
      if (isAuthenticated) {
        await initQlik();
      }
    })();
  </script>
</body>
</html>