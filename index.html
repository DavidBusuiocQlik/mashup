<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Qlik Cloud Mashup (GitHub Pages + credentials)</title>
  <style>
    body {
      margin: 0;
      padding: 32px;
      font-family: sans-serif;
      background: #f9f9f9;
    }
    #selections {
      height: 40px;
      margin-bottom: 16px;
    }
    #qs-object {
      height: 600px;
    }
    #error-message {
      color: red;
      margin-top: 16px;
      white-space: pre-wrap;
    }
  </style>
  <!-- Load require.js from CDN -->
  <script src="https://cdn.jsdelivr.net/gh/qlik-oss/requirejs@2.3.6/require.min.js"></script>
</head>
<body>
  <h2>Qlik Sheet Embed (with credentials)</h2>
  <div id="selections"></div>
  <div id="qs-object"></div>
  <div id="error-message"></div>

  <script>
    const tenant = "q-likhack251-459898.us.qlikcloud.com";
    const webIntegrationId = "458a485c626995e8a80a8bac9eb21ac1";
    const appId = "03011cc2-27b2-4060-9570-1275ee044884";
    const sheetId = "rXtfDa";

    function showError(msg) {
      document.getElementById("error-message").textContent = msg;
    }

    async function checkAuth() {
      try {
        const response = await fetch(`https://${tenant}/api/v1/users/me`, {
          method: "GET",
          credentials: "include", // IMPORTANT: send cookies/auth
          headers: {
            "qlik-web-integration-id": webIntegrationId
          }
        });

        if (response.status === 401) {
          // Not authenticated, redirect to login
          window.location.href = `https://${tenant}/login?qlik-web-integration-id=${webIntegrationId}&returnto=${encodeURIComponent(window.location.href)}`;
          return false;
        }

        if (!response.ok) {
          throw new Error(`Auth check failed with status ${response.status}`);
        }

        const user = await response.json();
        console.log("Authenticated user:", user);
        return true;

      } catch (err) {
        showError(`Authentication check error: ${err.message}`);
        return false;
      }
    }

    async function initQlik() {
      try {
        require.config({
          baseUrl: `https://${tenant}/resources`
        });

        require(["js/qlik"], (qlik) => {
          qlik.setOnError(error => {
            console.error("Qlik error:", error);
            showError("Qlik error: " + (error.message || error));
          });

          const app = qlik.openApp(appId, {
            host: tenant,
            prefix: "/",
            port: 443,
            isSecure: true,
            webIntegrationId: webIntegrationId
          });

          // Load selections toolbar (optional)
          app.getObject("selections", "CurrentSelections").catch(err => {
            console.warn("CurrentSelections object not loaded:", err);
          });

          // Load the full sheet
          app.getObject("qs-object", sheetId)
            .then(() => console.log("Sheet loaded"))
            .catch(err => {
              console.error("Sheet load error:", err);
              showError("Failed to load Qlik sheet: " + (err.message || err));
            });

          // Listen for postMessage to select Account_IDs
          window.addEventListener("message", (event) => {
            if (event.data?.type === "account_ids_selected") {
              const ids = event.data.accountIds || [];
              console.log("Received Account_IDs via postMessage:", ids);
              if (ids.length > 0) {
                app.field("Account_ID").selectValues(
                  ids.map(id => ({ qText: id })),
                  false,
                  false
                );
              }
            }
          });
        });
      } catch (err) {
        showError("Qlik init error: " + err.message);
      }
    }

    (async () => {
      const authed = await checkAuth();
      if (authed) {
        await initQlik();
      }
    })();
  </script>
</body>
</html>